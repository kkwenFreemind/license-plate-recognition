# é›»å­åœç±¬åœç•™æ™‚é–“åŠŸèƒ½æ›´æ–°èªªæ˜

## ğŸ“… æ›´æ–°æ—¥æœŸ
2025-11-06

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æ–°å¢**åœç•™æ™‚é–“é–¾å€¼ï¼ˆDwell Time Thresholdï¼‰**åŠŸèƒ½ï¼Œå…è¨±é›»å­åœç±¬åªåœ¨ç‰©ä»¶æ–¼ç¦å€å…§åœç•™é”åˆ°æŒ‡å®šæ™‚é–“ï¼ˆä¾‹å¦‚ 3 ç§’ï¼‰å¾Œæ‰è§¸ç™¼è­¦å ±ï¼Œæœ‰æ•ˆæ¸›å°‘èª¤å ±ã€‚

## âœ¨ ä¸»è¦ç‰¹é»

### 1. ç‰©ä»¶è¿½è¹¤
- ä½¿ç”¨ YOLO çš„ `track()` æ–¹æ³•ç‚ºæ¯å€‹ç‰©ä»¶åˆ†é…å”¯ä¸€çš„è¿½è¹¤ ID
- æŒçºŒè¿½è¹¤åŒä¸€ç‰©ä»¶åœ¨ä¸åŒå¹€ä¹‹é–“çš„ç‹€æ…‹

### 2. åœç•™æ™‚é–“ç´¯è¨ˆ
- ç²¾ç¢ºè¨ˆç®—ç‰©ä»¶åœ¨ç¦å€å…§çš„åœç•™æ™‚é–“
- è‡ªå‹•è™•ç†ç‰©ä»¶é€²å…¥ã€åœç•™ã€é›¢é–‹çš„ç‹€æ…‹è½‰æ›

### 3. å¯é…ç½®é–¾å€¼
- æ¯å€‹åœç±¬å¯è¨­å®šä¸åŒçš„åœç•™æ™‚é–“é–¾å€¼
- `dwell_time_threshold = 0.0` è¡¨ç¤ºç«‹å³è§¸ç™¼ï¼ˆé è¨­è¡Œç‚ºï¼‰
- `dwell_time_threshold > 0.0` è¡¨ç¤ºéœ€åœç•™æŒ‡å®šæ™‚é–“

### 4. è¦–è¦ºåŒ–å›é¥‹
- å³æ™‚é¡¯ç¤ºç‰©ä»¶åœç•™æ™‚é–“
- é€²åº¦æ¢é¡¯ç¤ºè·é›¢è§¸ç™¼é‚„æœ‰å¤šä¹…
- é¡è‰²å€åˆ†ï¼šæ©™è‰²ï¼ˆæœªè§¸ç™¼ï¼‰ã€ç´…è‰²ï¼ˆå·²è§¸ç™¼ï¼‰

### 5. è‡ªå‹•æ¸…ç†
- è‡ªå‹•æ¸…é™¤é•·æ™‚é–“æœªå‡ºç¾çš„ç‰©ä»¶è¨˜éŒ„
- é¿å…è¨˜æ†¶é«”ç´¯ç©

## ğŸ“ æª”æ¡ˆè®Šæ›´

### æ ¸å¿ƒæª”æ¡ˆä¿®æ”¹

#### 1. `modules/virtual_fence.py`
- **æ–°å¢åƒæ•¸**: `dwell_time_threshold` (åœç•™æ™‚é–“é–¾å€¼)
- **æ–°å¢å±¬æ€§**: `object_timeout` (ç‰©ä»¶æ¸…ç†è¶…æ™‚æ™‚é–“)
- **å¢å¼·è¿½è¹¤**: æ”¹é€²ç‰©ä»¶ç‹€æ…‹è¿½è¹¤çµæ§‹
  ```python
  {
      'in_zone': bool,          # æ˜¯å¦åœ¨å€åŸŸå…§
      'first_seen': timestamp,  # é¦–æ¬¡é€²å…¥æ™‚é–“
      'last_seen': timestamp,   # æœ€å¾Œå‡ºç¾æ™‚é–“
      'dwell_time': float,      # ç´¯è¨ˆåœç•™æ™‚é–“
      'triggered': bool,        # æ˜¯å¦å·²è§¸ç™¼
      'object_class': str,      # ç‰©ä»¶é¡åˆ¥
      'last_bbox': list         # æœ€å¾Œä½ç½®
  }
  ```
- **æ–°å¢æ–¹æ³•**:
  - `cleanup_old_objects()`: æ¸…ç†éæœŸç‰©ä»¶
  - `get_object_dwell_time(track_id)`: å–å¾—ç‰©ä»¶åœç•™æ™‚é–“
- **å¢å¼·æ–¹æ³•**:
  - `check_detection()`: æ”¯æ´åœç•™æ™‚é–“åˆ¤å®š
  - `draw_on_frame()`: é¡¯ç¤ºåœç•™æ™‚é–“å’Œé€²åº¦æ¢

### æ–°å¢æª”æ¡ˆ

#### 2. `examples/dwell_time_example.py`
å®Œæ•´çš„ç¯„ä¾‹ç¨‹å¼ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨åœç•™æ™‚é–“åŠŸèƒ½ï¼š
- åˆå§‹åŒ– YOLO è¿½è¹¤
- å‰µå»ºå¸¶é–¾å€¼çš„åœç±¬
- è™•ç†åµæ¸¬çµæœ
- è¦–è¦ºåŒ–é¡¯ç¤º

#### 3. `tests/test_dwell_time.py`
å®Œæ•´çš„æ¸¬è©¦å¥—ä»¶ï¼ŒåŒ…å«ï¼š
- åœç•™æ™‚é–“è¿½è¹¤æ¸¬è©¦
- å¤šç‰©ä»¶åŒæ™‚è¿½è¹¤æ¸¬è©¦
- ç‰©ä»¶æ¸…ç†åŠŸèƒ½æ¸¬è©¦
- åœç±¬ç®¡ç†å™¨æ¸¬è©¦

#### 4. `docs/document/DWELL_TIME_GUIDE.md`
è©³ç´°çš„ä½¿ç”¨æŒ‡å—ï¼ŒåŒ…å«ï¼š
- åŠŸèƒ½èªªæ˜
- å¿«é€Ÿé–‹å§‹
- å·¥ä½œåŸç†
- API åƒæ•¸èªªæ˜
- ä½¿ç”¨å ´æ™¯ç¯„ä¾‹
- æ•…éšœæ’é™¤

#### 5. `config/fence_with_dwell_time.example.yaml`
é…ç½®ç¯„ä¾‹ï¼Œå±•ç¤ºä¸åŒå ´æ™¯çš„è¨­å®šï¼š
- å€‰åº«å±éšªå€ï¼ˆ3 ç§’ï¼‰
- æ¶ˆé˜²é€šé“ï¼ˆ5 ç§’ï¼‰
- æ©Ÿå™¨å®‰å…¨å€ï¼ˆ2 ç§’ï¼‰
- åœè»Šå€ï¼ˆ10 ç§’ï¼‰

#### 6. æ‰¹æ¬¡æª”
- `test_dwell_time.bat`: åŸ·è¡Œæ¸¬è©¦
- `run_dwell_time_example.bat`: åŸ·è¡Œç¯„ä¾‹

### æ–‡ä»¶æ›´æ–°

#### 7. `README.md`
- æ–°å¢é›»å­åœç±¬åŠŸèƒ½èªªæ˜
- æ–°å¢åœç•™æ™‚é–“åŠŸèƒ½æè¿°
- æ–°å¢ç›¸é—œæ–‡ä»¶é€£çµ

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### é—œéµæ©Ÿåˆ¶

1. **ç‰©ä»¶è­˜åˆ¥**
   ```python
   # ä½¿ç”¨ track_id è­˜åˆ¥åŒä¸€ç‰©ä»¶
   detection = {
       'class': 'person',
       'confidence': 0.8,
       'bbox': [x1, y1, x2, y2],
       'track_id': 42  # é—œéµï¼šè¿½è¹¤ ID
   }
   ```

2. **æ™‚é–“ç´¯è¨ˆ**
   ```python
   # è¨ˆç®—åœç•™æ™‚é–“
   dwell_time = current_time - first_seen_time
   
   # æª¢æŸ¥æ˜¯å¦é”åˆ°é–¾å€¼
   if dwell_time >= dwell_time_threshold:
       trigger_alarm()
   ```

3. **ç‹€æ…‹ç®¡ç†**
   ```python
   # ç‰©ä»¶é€²å…¥
   if in_zone and track_id not in tracked_objects:
       create_new_record()
   
   # ç‰©ä»¶åœç•™
   elif in_zone and track_id in tracked_objects:
       update_dwell_time()
   
   # ç‰©ä»¶é›¢é–‹
   elif not in_zone and track_id in tracked_objects:
       mark_as_left()
   ```

## ğŸ“Š ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```python
from modules.virtual_fence import VirtualFence, VirtualFenceManager
from ultralytics import YOLO

# 1. å‰µå»ºåœç±¬ï¼ˆè¨­å®š 3 ç§’é–¾å€¼ï¼‰
fence = VirtualFence(
    fence_id="fence_001",
    name="å±éšªå€åŸŸ",
    points=[(100, 100), (500, 100), (500, 400), (100, 400)],
    target_classes=["person"],
    dwell_time_threshold=3.0  # åœç•™ 3 ç§’æ‰è§¸ç™¼
)

# 2. ä½¿ç”¨ YOLO è¿½è¹¤ï¼ˆé‡è¦ï¼šä½¿ç”¨ track è€Œé predictï¼‰
model = YOLO('yolov8n.pt')
results = model.track(frame, persist=True)

# 3. æª¢æŸ¥åœç±¬å…¥ä¾µ
detections = convert_results_to_detections(results)
intrusions = fence_manager.check_detections(detections)
```

### é…ç½®æ–‡ä»¶æ–¹å¼

```yaml
virtual_fences:
  fences:
    - id: "fence_001"
      name: "ç¦æ­¢åœç•™å€"
      points: [[100, 100], [500, 100], [500, 400], [100, 400]]
      target_classes: ["person"]
      min_confidence: 0.6
      dwell_time_threshold: 3.0  # æ–°å¢åƒæ•¸
```

## ğŸ¬ æ‡‰ç”¨å ´æ™¯

### 1. å€‰åº«å®‰å…¨ç›£æ§
```python
# äººå“¡ä¸å¾—åœ¨å±éšªå€åŸŸåœç•™è¶…é 3 ç§’
fence = VirtualFence(
    fence_id="warehouse_001",
    name="å±éšªç‰©å“å€",
    points=danger_zone_points,
    target_classes=["person"],
    dwell_time_threshold=3.0
)
```

### 2. è»Šè¼›ç¦åœç›£æ§
```python
# è»Šè¼›ä¸å¾—åœ¨æ¶ˆé˜²é€šé“åœç•™è¶…é 10 ç§’
fence = VirtualFence(
    fence_id="fire_lane_001",
    name="æ¶ˆé˜²é€šé“",
    points=fire_lane_points,
    target_classes=["car", "truck", "bus"],
    dwell_time_threshold=10.0
)
```

### 3. æ©Ÿå™¨æ“ä½œå®‰å…¨
```python
# äººå“¡æ¥è¿‘æ©Ÿå™¨è¶…é 2 ç§’ç™¼å‡ºè­¦å‘Š
fence = VirtualFence(
    fence_id="machine_001",
    name="æ©Ÿå™¨å±éšªå€",
    points=machine_zone_points,
    target_classes=["person"],
    dwell_time_threshold=2.0
)
```

## ğŸ§ª æ¸¬è©¦æ–¹å¼

### 1. å–®å…ƒæ¸¬è©¦
```bash
python tests/test_dwell_time.py
```
æˆ–
```bash
test_dwell_time.bat
```

### 2. ç¯„ä¾‹ç¨‹å¼
```bash
python examples/dwell_time_example.py
```
æˆ–
```bash
run_dwell_time_example.bat
```

æ¸¬è©¦æ¶µè“‹ï¼š
- âœ… åœç•™æ™‚é–“è¿½è¹¤
- âœ… è§¸ç™¼é–¾å€¼åˆ¤å®š
- âœ… å¤šç‰©ä»¶åŒæ™‚è¿½è¹¤
- âœ… ç‰©ä»¶æ¸…ç†åŠŸèƒ½
- âœ… å›èª¿å‡½æ•¸æ©Ÿåˆ¶

## âš ï¸ é‡è¦æ³¨æ„äº‹é …

### 1. å¿…é ˆä½¿ç”¨ç‰©ä»¶è¿½è¹¤
```python
# âŒ éŒ¯èª¤ï¼šä½¿ç”¨ predict
results = model.predict(frame)

# âœ… æ­£ç¢ºï¼šä½¿ç”¨ track
results = model.track(frame, persist=True)
```

### 2. å¿…é ˆå‚³å…¥ track_id
```python
# âœ… ç¢ºä¿ detection åŒ…å« track_id
detection = {
    'class': 'person',
    'confidence': 0.85,
    'bbox': [100, 150, 200, 300],
    'track_id': 42  # å¿…é ˆåŒ…å«
}
```

### 3. é–¾å€¼è¨­å®šå»ºè­°
- **å¤ªçŸ­ï¼ˆ< 1 ç§’ï¼‰**: å¯èƒ½ä»æœ‰èª¤å ±
- **å¤ªé•·ï¼ˆ> 10 ç§’ï¼‰**: åæ‡‰éæ…¢
- **å»ºè­°ç¯„åœ**: 2-5 ç§’

## ğŸš€ æ•ˆèƒ½å½±éŸ¿

### è¨ˆç®—é–‹éŠ·
- **é¡å¤–è¨ˆç®—**: å¾®å°ï¼ˆåƒ…æ™‚é–“æˆ³è¨˜å’Œç‹€æ…‹æ›´æ–°ï¼‰
- **è¨˜æ†¶é«”ä½¿ç”¨**: æ¯å€‹è¿½è¹¤ç‰©ä»¶ç´„ 200 bytes
- **FPS å½±éŸ¿**: < 5%ï¼ˆåœ¨è¿½è¹¤æ¨¡å¼ä¸‹ï¼‰

### å„ªåŒ–å»ºè­°
1. å®šæœŸèª¿ç”¨ `cleanup_old_objects()` æ¸…ç†éæœŸè¨˜éŒ„
2. åˆç†è¨­å®š `object_timeout` åƒæ•¸
3. é™åˆ¶åŒæ™‚è¿½è¹¤çš„ç‰©ä»¶æ•¸é‡

## ğŸ”„ å‘å¾Œå…¼å®¹æ€§

### å®Œå…¨å…¼å®¹
- å¦‚æœä¸è¨­å®š `dwell_time_threshold`ï¼Œé è¨­ç‚º 0.0ï¼ˆç«‹å³è§¸ç™¼ï¼‰
- å¦‚æœä¸æä¾› `track_id`ï¼Œä»æœƒä½¿ç”¨èˆŠçš„ç«‹å³è§¸ç™¼é‚è¼¯
- ç¾æœ‰é…ç½®æ–‡ä»¶ç„¡éœ€ä¿®æ”¹å³å¯ç¹¼çºŒä½¿ç”¨

### å‡ç´šè·¯å¾‘
```python
# èˆŠç‰ˆæœ¬ï¼ˆä»ç„¶å¯ç”¨ï¼‰
fence = VirtualFence(
    fence_id="fence_001",
    name="ç¦æ­¢å€",
    points=points
)

# æ–°ç‰ˆæœ¬ï¼ˆå•Ÿç”¨åœç•™æ™‚é–“åŠŸèƒ½ï¼‰
fence = VirtualFence(
    fence_id="fence_001",
    name="ç¦æ­¢å€",
    points=points,
    dwell_time_threshold=3.0  # æ–°å¢åƒæ•¸
)
```

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [åœç•™æ™‚é–“åŠŸèƒ½æŒ‡å—](DWELL_TIME_GUIDE.md) - å®Œæ•´ä½¿ç”¨èªªæ˜
- [è™›æ“¬åœç±¬æŒ‡å—](VIRTUAL_FENCE_GUIDE.md) - åŸºç¤åŠŸèƒ½èªªæ˜
- [äº‹ä»¶è™•ç†æŒ‡å—](FENCE_EVENT_GUIDE.md) - äº‹ä»¶å›èª¿èªªæ˜

## ğŸ› å·²çŸ¥é™åˆ¶

1. **è¿½è¹¤ç©©å®šæ€§**: ç‰©ä»¶è¢«é®æ“‹æ™‚å¯èƒ½æœƒåˆ†é…æ–°çš„ ID
2. **ID é‡è¤‡ä½¿ç”¨**: åœ¨é•·æ™‚é–“é‹è¡Œå¾Œï¼ŒID å¯èƒ½æœƒè¢«é‡è¤‡ä½¿ç”¨
3. **æ”å½±æ©Ÿè§’åº¦**: è¿½è¹¤æ•ˆæœå—æ”å½±æ©Ÿè§’åº¦å½±éŸ¿

## ğŸ’¡ æœªä¾†æ”¹é€²æ–¹å‘

1. **æŒä¹…åŒ–è¿½è¹¤**: è·¨å¹€ç©©å®šè¿½è¹¤
2. **å¤šæ”å½±æ©Ÿèåˆ**: è·¨æ”å½±æ©Ÿè¿½è¹¤åŒä¸€ç‰©ä»¶
3. **è»Œè·¡åˆ†æ**: åˆ†æç‰©ä»¶ç§»å‹•è»Œè·¡
4. **ç•°å¸¸åµæ¸¬**: åµæ¸¬ç•°å¸¸è¡Œç‚ºæ¨¡å¼

## ğŸ‘¥ è²¢ç»è€…

- æ ¸å¿ƒé–‹ç™¼: CCTV Team
- åŠŸèƒ½éœ€æ±‚: å®¢æˆ¶åé¥‹

## ğŸ“ æŠ€è¡“æ”¯æ´

å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œè«‹ï¼š
1. æŸ¥é–±ç›¸é—œæ–‡ä»¶
2. åŸ·è¡Œæ¸¬è©¦è…³æœ¬é©—è­‰åŠŸèƒ½
3. æäº¤ Issue æˆ–è¯ç¹«é–‹ç™¼åœ˜éšŠ

---

**ç‰ˆæœ¬**: v1.1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-11-06  
**ç‹€æ…‹**: âœ… ç©©å®šç‰ˆæœ¬
