# é›»å­åœç±¬å…¥ä¾µäº‹ä»¶è¨˜éŒ„ç³»çµ±ä½¿ç”¨æŒ‡å—

## ğŸ“Œ ç³»çµ±æ¦‚è¿°

é€™å€‹ç³»çµ±å°ˆæ³¨æ–¼**é›»å­åœç±¬å…¥ä¾µåµæ¸¬**ï¼Œç•¶æœ‰äººå“¡é€²å…¥é å®šç¾©çš„åœç±¬å€åŸŸæ™‚ï¼š
- âœ… å³æ™‚è§¸ç™¼è­¦å ±
- âœ… è¨˜éŒ„å…¥ä¾µäº‹ä»¶åˆ°è³‡æ–™åº«
- âœ… å„²å­˜å…¥ä¾µç•¶ä¸‹çš„å½±åƒæˆªåœ–ï¼ˆBase64 æ ¼å¼ï¼‰
- âœ… åœ¨ç¶²é ä»‹é¢å³æ™‚é¡¯ç¤ºè­¦å ±

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. å•Ÿå‹•ç³»çµ±

```cmd
start_web.bat
```

æˆ–

```cmd
python web_server.py
```

### 2. é–‹å•Ÿç›£æ§ä»‹é¢

é–‹å•Ÿç€è¦½å™¨è¨ªå•ï¼š

- **é›»å­åœç±¬ç›£æ§é é¢**ï¼šhttp://localhost:5000/fence
- **ä¸€èˆ¬ç‰©ä»¶åµæ¸¬é é¢**ï¼šhttp://localhost:5000/

### 3. æŸ¥çœ‹æ•ˆæœ

- **å·¦å´**ï¼šå³æ™‚å½±åƒä¸²æµï¼Œæœƒé¡¯ç¤ºç´…è‰²åŠé€æ˜çš„åœç±¬å€åŸŸ
- **å³å´**ï¼šåœç±¬å…¥ä¾µäº‹ä»¶è¨˜éŒ„ï¼Œé¡¯ç¤ºæ‰€æœ‰è§¸ç™¼çš„è­¦å ±
- **å³ä¸Šè§’**ï¼šå½ˆå‡ºå¼è­¦å ±é€šçŸ¥ï¼ˆ5 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰

---

## ğŸ—„ï¸ è³‡æ–™åº«çµæ§‹

### fence_intrusions è³‡æ–™è¡¨

| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
|---------|------|------|
| `id` | SERIAL | ä¸»éµ |
| `fence_id` | VARCHAR(50) | åœç±¬ ID |
| `fence_name` | VARCHAR(100) | åœç±¬åç¨± |
| `object_class` | VARCHAR(50) | ç‰©ä»¶é¡å‹ï¼ˆperson, car, etc.ï¼‰ |
| `confidence` | FLOAT | ä¿¡å¿ƒåº¦ï¼ˆ0.0-1.0ï¼‰ |
| `bbox_x1, bbox_y1` | INTEGER | é‚Šç•Œæ¡†å·¦ä¸Šè§’åº§æ¨™ |
| `bbox_x2, bbox_y2` | INTEGER | é‚Šç•Œæ¡†å³ä¸‹è§’åº§æ¨™ |
| `camera_id` | VARCHAR(100) | æ”å½±æ©Ÿ ID |
| `camera_name` | VARCHAR(100) | æ”å½±æ©Ÿåç¨± |
| `snapshot_base64` | TEXT | **å…¥ä¾µæˆªåœ–ï¼ˆBase64 ç·¨ç¢¼ï¼‰** |
| `timestamp` | TIMESTAMP | å…¥ä¾µæ™‚é–“ |
| `created_at` | TIMESTAMP | è¨˜éŒ„å»ºç«‹æ™‚é–“ |

### ç´¢å¼•

ç³»çµ±å·²å»ºç«‹ä»¥ä¸‹ç´¢å¼•ä»¥æå‡æŸ¥è©¢æ•ˆèƒ½ï¼š
- `idx_fence_intrusions_fence_id`ï¼šä¾åœç±¬ ID æŸ¥è©¢
- `idx_fence_intrusions_timestamp`ï¼šä¾æ™‚é–“æ’åº
- `idx_fence_intrusions_object_class`ï¼šä¾ç‰©ä»¶é¡å‹éæ¿¾
- `idx_fence_intrusions_camera_id`ï¼šä¾æ”å½±æ©ŸæŸ¥è©¢

---

## ğŸ¨ ç¶²é ä»‹é¢åŠŸèƒ½

### é›»å­åœç±¬ç›£æ§é é¢ï¼ˆ/fenceï¼‰

#### çµ±è¨ˆå¡ç‰‡
- **ç¸½åµæ¸¬æ•¸**ï¼šæ‰€æœ‰ç‰©ä»¶åµæ¸¬ç¸½æ•¸
- **åœç±¬å…¥ä¾µäº‹ä»¶**ï¼šè§¸ç™¼é›»å­åœç±¬è­¦å ±çš„æ¬¡æ•¸ï¼ˆç´…è‰²èƒŒæ™¯ï¼‰

#### å³æ™‚å½±åƒ
- é¡¯ç¤º RTSP æ”å½±æ©Ÿä¸²æµ
- ç¹ªè£½é›»å­åœç±¬å€åŸŸï¼ˆç´…è‰²åŠé€æ˜å¤šé‚Šå½¢ï¼‰
- æ¡†é¸åµæ¸¬åˆ°çš„ç‰©ä»¶

#### å…¥ä¾µäº‹ä»¶è¨˜éŒ„ï¼ˆå³å´ï¼‰
- **å³æ™‚æ›´æ–°**ï¼šæ–°äº‹ä»¶æœƒè‡ªå‹•å‡ºç¾åœ¨æœ€ä¸Šæ–¹
- **è©³ç´°è³‡è¨Š**ï¼š
  - åœç±¬åç¨±
  - ç‰©ä»¶é¡å‹ï¼ˆå¸¶ emoji åœ–ç¤ºï¼‰
  - ä¿¡å¿ƒåº¦ç™¾åˆ†æ¯”
  - æ”å½±æ©Ÿåç¨±
  - å…¥ä¾µæ™‚é–“
- **å½±åƒæˆªåœ–**ï¼šé»æ“Šå¡ç‰‡å±•é–‹æŸ¥çœ‹å…¥ä¾µç•¶ä¸‹çš„æˆªåœ–
- **åœ–ç‰‡æ”¾å¤§**ï¼šé»æ“Šæˆªåœ–å¯ä»¥å…¨è¢å¹•æª¢è¦–
- **æ­·å²è¨˜éŒ„**ï¼šé é¢è¼‰å…¥æ™‚æœƒè‡ªå‹•è¼‰å…¥æœ€è¿‘ 20 ç­†å…¥ä¾µè¨˜éŒ„
- **è‡ªå‹•é™åˆ¶**ï¼šæœ€å¤šé¡¯ç¤º 50 ç­†è¨˜éŒ„

#### è­¦å ±é€šçŸ¥
- å³ä¸Šè§’å½ˆå‡ºå¼é€šçŸ¥
- ç´…è‰²æ¼¸å±¤èƒŒæ™¯
- æ»‘å…¥å‹•ç•«æ•ˆæœ
- 5 ç§’å¾Œè‡ªå‹•æ·¡å‡º
- è­¦å ±éŸ³æ•ˆæç¤ºï¼ˆå¯é¸ï¼‰

---

## âš™ï¸ é…ç½®èªªæ˜

### config/config.yaml

```yaml
virtual_fences:
  enabled: true
  fences:
    - id: "fence_001"
      name: "äººå“¡ç¦å…¥å€"
      points:
        - [200, 150]
        - [600, 150]
        - [600, 450]
        - [200, 450]
      target_classes: ["person"]  # åªåµæ¸¬äººå“¡
      min_confidence: 0.6
      enabled: true
```

### èª¿æ•´åƒæ•¸

- **target_classes**: æŒ‡å®šè¦åµæ¸¬çš„ç‰©ä»¶é¡å‹
  - `["person"]` - åªåµæ¸¬äººå“¡
  - `["person", "car"]` - åµæ¸¬äººå“¡å’Œæ±½è»Š
  - `[]` - åµæ¸¬æ‰€æœ‰é¡å‹

- **min_confidence**: ä¿¡å¿ƒåº¦é–¾å€¼ï¼ˆ0.0-1.0ï¼‰
  - è¼ƒé«˜å€¼ï¼ˆ0.7-0.9ï¼‰ï¼šæ¸›å°‘èª¤å ±ï¼Œä½†å¯èƒ½æ¼å ±
  - è¼ƒä½å€¼ï¼ˆ0.4-0.6ï¼‰ï¼šåµæ¸¬æ›´éˆæ•ï¼Œä½†å¯èƒ½èª¤å ±

---

## ğŸ“Š API ç«¯é»

### GET /api/fence_intrusions

æŸ¥è©¢åœç±¬å…¥ä¾µè¨˜éŒ„

**åƒæ•¸ï¼š**
- `limit`ï¼ˆå¯é¸ï¼‰ï¼šå›å‚³ç­†æ•¸ï¼Œé è¨­ 50
- `fence_id`ï¼ˆå¯é¸ï¼‰ï¼šç¯©é¸ç‰¹å®šåœç±¬

**ç¯„ä¾‹ï¼š**
```
GET /api/fence_intrusions?limit=20
GET /api/fence_intrusions?fence_id=fence_001
```

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "count": 15,
  "data": [
    {
      "id": 1,
      "fence_id": "fence_001",
      "fence_name": "äººå“¡ç¦å…¥å€",
      "object_class": "person",
      "confidence": 0.85,
      "bbox": [320, 180, 450, 480],
      "camera_id": "bd687687-07ef-1bbc-4018-2e6371fe41a0",
      "camera_name": "æ¿æ©‹",
      "snapshot_base64": "/9j/4AAQSkZJRgABAQAA...",
      "timestamp": "2025-11-06T14:30:15"
    }
  ]
}
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. ç³»çµ±åˆå§‹åŒ–
```
è¼‰å…¥é…ç½® â†’ é€£æ¥è³‡æ–™åº« â†’ åˆå§‹åŒ–é›»å­åœç±¬ â†’ è¼‰å…¥ YOLO æ¨¡å‹ â†’ é€£æ¥ RTSP
```

### 2. å…¥ä¾µåµæ¸¬æµç¨‹
```
è®€å–å½±åƒå¹€ â†’ YOLO ç‰©ä»¶åµæ¸¬ â†’ æª¢æŸ¥åœç±¬å…¥ä¾µ â†’ æ“·å–æˆªåœ– â†’ å„²å­˜åˆ°è³‡æ–™åº« â†’ ç™¼é€ WebSocket
```

### 3. è³‡æ–™å„²å­˜
```python
# web_server.py ä¸­çš„è™•ç†é‚è¼¯
if intrusions:
    for intrusion in intrusions:
        # 1. æ“·å–ç•¶å‰å½±åƒä¸¦è½‰æˆ base64
        _, buffer = cv2.imencode('.jpg', annotated_frame, [cv2.IMWRITE_JPEG_QUALITY, 85])
        snapshot_base64 = base64.b64encode(buffer).decode('utf-8')
        
        # 2. æº–å‚™è³‡æ–™
        intrusion_data = {
            'fence_id': intrusion['fence_id'],
            'fence_name': intrusion['fence_name'],
            'object_class': intrusion['object_class'],
            'confidence': intrusion['confidence'],
            'bbox': intrusion['bbox'],
            'camera_id': camera_id,
            'camera_name': cam.get('name'),
            'snapshot_base64': snapshot_base64,
            'timestamp': intrusion['timestamp']
        }
        
        # 3. å„²å­˜åˆ°è³‡æ–™åº«
        db_handler.save_fence_intrusion(intrusion_data)
        
        # 4. ç™¼é€åˆ°å‰ç«¯
        socketio.emit('fence_intrusion', intrusion_data, namespace='/detections')
```

---

## ğŸ’¡ ä½¿ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šè¾¦å…¬å®¤å®‰å…¨ç›£æ§

**éœ€æ±‚**ï¼šåµæ¸¬ä¸‹ç­å¾Œæœ‰äººå“¡é€²å…¥æ©Ÿæˆ¿

**é…ç½®**ï¼š
```yaml
- id: "server_room_afterhours"
  name: "æ©Ÿæˆ¿å¤œé–“ç¦å…¥"
  points: [[300, 200], [800, 200], [800, 700], [300, 700]]
  target_classes: ["person"]
  min_confidence: 0.7
```

**æ•ˆæœ**ï¼š
- ç•¶æœ‰äººé€²å…¥æ©Ÿæˆ¿å€åŸŸæ™‚ç«‹å³è­¦å ±
- è¨˜éŒ„å…¥ä¾µæ™‚é–“å’Œäººå“¡ä½ç½®
- å„²å­˜å…¥ä¾µç•¶ä¸‹çš„å½±åƒè­‰æ“š

### æ¡ˆä¾‹ 2ï¼šå·¥åœ°å®‰å…¨ç®¡åˆ¶

**éœ€æ±‚**ï¼šç›£æ§å±éšªå€åŸŸæ˜¯å¦æœ‰äººå“¡é€²å…¥

**é…ç½®**ï¼š
```yaml
- id: "danger_zone"
  name: "é«˜ç©ºä½œæ¥­å±éšªå€"
  points: [[100, 150], [500, 150], [500, 600], [100, 600]]
  target_classes: ["person"]
  min_confidence: 0.6
```

### æ¡ˆä¾‹ 3ï¼šåœè»Šå ´è»Šä½ç›£æ§

**éœ€æ±‚**ï¼šåµæ¸¬ç‰¹å®šè»Šä½æ˜¯å¦è¢«å ç”¨

**é…ç½®**ï¼š
```yaml
- id: "vip_parking"
  name: "VIP å°ˆç”¨è»Šä½"
  points: [[400, 300], [550, 300], [550, 450], [400, 450]]
  target_classes: ["car", "truck"]
  min_confidence: 0.5
```

---

## ğŸ› ç–‘é›£æ’è§£

### Q1: è³‡æ–™è¡¨ä¸å­˜åœ¨

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
relation "fence_intrusions" does not exist
```

**è§£æ±ºæ–¹æ³•**ï¼š
```cmd
$env:PGCLIENTENCODING='UTF8'; Get-Content -Path database\migrations\create_fence_intrusions_table.sql -Encoding UTF8 | psql -U postgres -d yolodb
```

### Q2: åœ–ç‰‡å¤ªå¤§å°è‡´å„²å­˜å¤±æ•—

**èª¿æ•´ JPEG å£“ç¸®å“è³ª**ï¼š
```python
# åœ¨ web_server.py ä¸­é™ä½å“è³ªåƒæ•¸
_, buffer = cv2.imencode('.jpg', annotated_frame, [cv2.IMWRITE_JPEG_QUALITY, 70])  # å¾ 85 é™åˆ° 70
```

### Q3: æŸ¥è©¢æ­·å²è¨˜éŒ„å¤ªæ…¢

**å„ªåŒ–æŸ¥è©¢**ï¼š
- é™åˆ¶æŸ¥è©¢ç­†æ•¸ï¼š`/api/fence_intrusions?limit=10`
- ä¾åœç±¬ç¯©é¸ï¼š`/api/fence_intrusions?fence_id=fence_001`
- è³‡æ–™åº«å·²è‡ªå‹•å»ºç«‹ç´¢å¼•åŠ é€ŸæŸ¥è©¢

### Q4: Base64 åœ–ç‰‡ç„¡æ³•é¡¯ç¤º

**æª¢æŸ¥å‰ç«¯ç¨‹å¼ç¢¼**ï¼š
```javascript
// ç¢ºä¿æœ‰ data URI å‰ç¶´
<img src="data:image/jpeg;base64,${data.snapshot_base64}">
```

---

## ğŸ“ˆ æ•ˆèƒ½å„ªåŒ–å»ºè­°

### 1. åœ–ç‰‡å„²å­˜ç­–ç•¥

**æ–¹æ¡ˆ Aï¼šBase64 å„²å­˜åœ¨è³‡æ–™åº«ï¼ˆç›®å‰æ–¹æ¡ˆï¼‰**
- âœ… å„ªé»ï¼šè³‡æ–™å®Œæ•´æ€§é«˜ï¼Œä¸éœ€è¦æª”æ¡ˆç³»çµ±
- âŒ ç¼ºé»ï¼šè³‡æ–™åº«é«”ç©å¤§ï¼ŒæŸ¥è©¢é€Ÿåº¦è¼ƒæ…¢

**æ–¹æ¡ˆ Bï¼šæª”æ¡ˆç³»çµ± + è·¯å¾‘å„²å­˜**
```python
# å„²å­˜åˆ°æª”æ¡ˆ
filename = f"intrusion_{fence_id}_{timestamp}.jpg"
cv2.imwrite(f"static/snapshots/{filename}", annotated_frame)

# è³‡æ–™åº«åªå­˜è·¯å¾‘
intrusion_data['snapshot_path'] = filename
```

### 2. å®šæœŸæ¸…ç†èˆŠè¨˜éŒ„

å»ºè­°æ¯æœˆæ¸…ç† 30 å¤©å‰çš„è¨˜éŒ„ï¼š
```sql
DELETE FROM fence_intrusions 
WHERE timestamp < NOW() - INTERVAL '30 days';
```

### 3. é™ä½è™•ç†é »ç‡

åœ¨ `config.yaml` ä¸­èª¿æ•´ï¼š
```yaml
cameras:
  - process_interval: 2.0  # 2 ç§’è™•ç†ä¸€æ¬¡ï¼ˆé è¨­ 1 ç§’ï¼‰
```

---

## ğŸ” å®‰å…¨å»ºè­°

1. **è³‡æ–™åº«å‚™ä»½**ï¼šå®šæœŸå‚™ä»½ `fence_intrusions` è¡¨
2. **åœ–ç‰‡ä¿ç•™æ”¿ç­–**ï¼šè¨­å®šè‡ªå‹•æ¸…ç†æ©Ÿåˆ¶
3. **å­˜å–æ§åˆ¶**ï¼šWeb ä»‹é¢åŠ ä¸Šå¯†ç¢¼ä¿è­·
4. **HTTPS**ï¼šç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ HTTPS åŠ å¯†å‚³è¼¸

---

## ğŸ“ ç›¸é—œæ–‡æª”

- [VIRTUAL_FENCE_GUIDE.md](VIRTUAL_FENCE_GUIDE.md) - é›»å­åœç±¬åŠŸèƒ½å®Œæ•´æŒ‡å—
- [WEB_DEMO_GUIDE.md](WEB_DEMO_GUIDE.md) - ç¶²é å±•ç¤ºä»‹é¢æŒ‡å—
- [QUICKSTART.md](QUICKSTART.md) - å¿«é€Ÿé–‹å§‹æŒ‡å—

---

## ğŸ¯ ä¸‹ä¸€æ­¥æ“´å±•

å¯ä»¥è€ƒæ…®åŠ å…¥çš„åŠŸèƒ½ï¼š
- [ ] Email æˆ– LINE è­¦å ±é€šçŸ¥
- [ ] äº‹ä»¶çµ±è¨ˆåœ–è¡¨ï¼ˆæ¯æ—¥/æ¯é€±è¶¨å‹¢ï¼‰
- [ ] å¤šæ”å½±æ©Ÿæ”¯æ´
- [ ] åŒ¯å‡ºå…¥ä¾µå ±å‘Šï¼ˆPDF/Excelï¼‰
- [ ] åœ–ç‰‡å£“ç¸®/ç¸®åœ–åŠŸèƒ½
- [ ] å³æ™‚èªéŸ³è­¦å ±
