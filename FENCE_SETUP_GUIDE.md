# 互動式圍籬設定工具使用指南

## 🎯 功能說明

這個工具讓您可以**直接在瀏覽器中**用滑鼠點擊即時影像來設定電子圍籬區域，不需要手動計算座標！

---

## 🚀 快速開始

### 1. 啟動伺服器

確保 Web 伺服器正在運行：

```cmd
python web_server.py
```

或

```cmd
start_web.bat
```

### 2. 開啟圍籬設定頁面

在瀏覽器中訪問：

**http://localhost:5000/fence/setup**

---

## 📖 操作步驟

### 步驟 1：查看即時影像

頁面載入後會自動抓取當前 RTSP 攝影機的即時影像，您會看到：
- 影像尺寸資訊（原始尺寸 vs 顯示尺寸）
- 縮放比例

### 步驟 2：選取圍籬區域

在影像上用滑鼠點擊選取多邊形的頂點：

1. **左鍵點擊**：選取第 1 個點
2. **左鍵點擊**：選取第 2 個點
3. **左鍵點擊**：選取第 3 個點（至少需要 3 個點）
4. **繼續點擊**：可以選取更多點（建議 4-8 個點）
5. **右鍵點擊**：完成選取

**提示**：
- 綠色圓點：已選取的頂點（帶編號）
- 綠色線條：連接各頂點的邊界
- 黃色預覽線：跟隨滑鼠的預覽線
- 紅色半透明：完成後的圍籬區域

### 步驟 3：設定圍籬資訊

在右側控制面板填寫：

| 欄位 | 說明 | 範例 |
|------|------|------|
| **圍籬 ID** | 唯一識別碼 | `fence_001` |
| **圍籬名稱** | 顯示用名稱 | `人員禁入區` |
| **目標類型** | 要偵測的物件（逗號分隔） | `person` 或 `person,car` |
| **最小信心度** | 0.0-1.0，預設 0.6 | `0.6` |

### 步驟 4：儲存配置

1. 點擊 **「✅ 完成」** 按鈕完成選取
2. 圍籬區域會變成紅色半透明
3. 點擊 **「💾 儲存配置」** 按鈕
4. 系統會自動更新 `config/config.yaml`
5. 3 秒後自動跳轉到監控頁面

### 步驟 5：重啟伺服器（重要！）

配置儲存後，**必須重新啟動伺服器**才能套用新設定：

```cmd
# 在終端機按 Ctrl+C 停止伺服器
# 然後重新啟動
python web_server.py
```

---

## 🎨 操作示範

### 範例 1：選取矩形區域

適合監控門口、走廊等矩形空間：

```
點擊順序：
1. 左上角 → 2. 右上角 → 3. 右下角 → 4. 左下角 → 右鍵完成
```

### 範例 2：選取不規則區域

適合監控斜角、L型等複雜區域：

```
點擊順序：
1. 點 A → 2. 點 B → 3. 點 C → 4. 點 D → 5. 點 E → 右鍵完成
```

---

## 🔧 常見操作

### 重新選取

如果選錯點了，點擊 **「🔄 重置」** 按鈕清除所有點，重新開始。

### 調整座標精度

系統會自動將顯示座標轉換回原始影像尺寸，確保精確度。

### 檢視座標

完成選取後，瀏覽器控制台（F12）會顯示實際座標：

```
✓ 已選取點 1: (320, 180)
✓ 已選取點 2: (640, 180)
✓ 已選取點 3: (640, 480)
✓ 已選取點 4: (320, 480)
```

---

## 📊 配置檔案格式

儲存後，`config/config.yaml` 會更新為：

```yaml
virtual_fences:
  enabled: true
  fences:
    - id: "fence_001"
      name: "人員禁入區"
      points:
        - [320, 180]
        - [640, 180]
        - [640, 480]
        - [320, 480]
      target_classes: ["person"]
      min_confidence: 0.6
      enabled: true
```

---

## 🎯 使用情境

### 情境 1：辦公室門口監控

**需求**：監控誰在下班後進入辦公室

**操作**：
1. 開啟 http://localhost:5000/fence/setup
2. 在門口區域點擊 4 個角
3. 設定：
   - 名稱：`辦公室門口`
   - 目標：`person`
   - 信心度：`0.7`

### 情境 2：停車場特定車位

**需求**：監控 VIP 車位是否被占用

**操作**：
1. 在車位範圍點擊 4 個角
2. 設定：
   - 名稱：`VIP 車位 A1`
   - 目標：`car,truck`
   - 信心度：`0.5`

### 情境 3：工地危險區域

**需求**：偵測有人進入施工危險區

**操作**：
1. 在危險區域邊界點擊 6-8 個點（不規則形狀）
2. 設定：
   - 名稱：`高空作業危險區`
   - 目標：`person`
   - 信心度：`0.6`

---

## 💡 使用技巧

### 技巧 1：選取技巧

- ✅ **從左上角開始**，順時針或逆時針選取
- ✅ **點數適中**：4-6 個點通常就夠（太多點反而複雜）
- ✅ **留點餘裕**：圍籬範圍稍微大一點，避免漏報

### 技巧 2：精準選點

- 🎯 放大瀏覽器（Ctrl + 滾輪）可以更精準點擊
- 🎯 使用滑鼠而非觸控板
- 🎯 預覽黃線可以幫助對齊

### 技巧 3：多圍籬設定

如果需要設定多個圍籬：

1. 完成第一個圍籬後儲存
2. 重新整理頁面（F5）
3. 選取第二個圍籬區域
4. 修改圍籬 ID（例如：`fence_002`）
5. 儲存

---

## 🐛 疑難排解

### Q1: 頁面顯示「正在載入即時影像...」但一直沒有畫面

**可能原因**：
- RTSP 攝影機尚未連線
- 伺服器還在初始化

**解決方法**：
1. 檢查伺服器日誌是否顯示「✓ RTSP 連接成功」
2. 等待 10-15 秒後重新整理頁面（F5）
3. 確認 http://localhost:5000/ 可以看到影像串流

### Q2: 點擊「儲存配置」後出現錯誤

**可能原因**：
- 配置檔案權限問題
- YAML 格式錯誤

**解決方法**：
1. 檢查瀏覽器控制台（F12）查看詳細錯誤
2. 確認 `config/config.yaml` 檔案存在且可寫入
3. 檢查伺服器日誌

### Q3: 座標不準確

**原因**：顯示尺寸與原始尺寸不同

**說明**：系統會自動轉換，無需擔心。頁面上方會顯示：
```
影像尺寸: 1920 x 1080 | 顯示尺寸: 900 x 506 | 縮放比例: 46.9%
```

### Q4: 想要微調座標

**方法 1**：直接編輯 `config/config.yaml`
```yaml
points:
  - [320, 180]  # 手動微調數字
  - [640, 180]
```

**方法 2**：重新整理頁面，重新選取

---

## 🔄 完整工作流程

```
1. 啟動伺服器
   ↓
2. 開啟 http://localhost:5000/fence/setup
   ↓
3. 等待載入即時影像
   ↓
4. 滑鼠點擊選取圍籬頂點（至少 3 個）
   ↓
5. 右鍵完成選取
   ↓
6. 填寫圍籬設定（ID、名稱、目標類型、信心度）
   ↓
7. 點擊「儲存配置」
   ↓
8. 等待 3 秒自動跳轉
   ↓
9. 重新啟動伺服器（套用新設定）
   ↓
10. 開啟 http://localhost:5000/fence 查看效果
```

---

## 🎥 相關頁面

- **http://localhost:5000/** - 一般物件偵測
- **http://localhost:5000/fence** - 電子圍籬監控
- **http://localhost:5000/fence/setup** - 圍籬設定工具（本頁面）

---

## 📝 相關文檔

- [FENCE_EVENT_GUIDE.md](FENCE_EVENT_GUIDE.md) - 圍籬入侵事件記錄系統
- [VIRTUAL_FENCE_GUIDE.md](VIRTUAL_FENCE_GUIDE.md) - 電子圍籬完整指南
- [WEB_DEMO_GUIDE.md](WEB_DEMO_GUIDE.md) - 網頁展示介面指南

---

**提示**：第一次使用建議先用矩形區域練習，熟悉後再嘗試複雜的不規則形狀！
