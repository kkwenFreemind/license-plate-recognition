<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»å­åœç±¬ç›£æ§ç³»çµ± - å³æ™‚å±•ç¤º</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            background: #10b981;
            color: white;
            border-radius: 20px;
            font-size: 14px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .video-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .video-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }

        #video-stream {
            width: 100%;
            height: auto;
            border-radius: 8px;
            background: #000;
        }

        .intrusions-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 800px;
            overflow-y: auto;
        }

        .intrusions-section h2 {
            color: #ff4757;
            margin-bottom: 15px;
            font-size: 20px;
            position: sticky;
            top: 0;
            background: white;
            padding-bottom: 10px;
            border-bottom: 2px solid #ff4757;
        }

        .intrusion-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease-out;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .intrusion-card:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        @keyframes slideIn {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .intrusion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .intrusion-title {
            font-size: 16px;
            font-weight: bold;
        }

        .intrusion-time {
            font-size: 12px;
            opacity: 0.9;
        }

        .intrusion-details {
            font-size: 14px;
            line-height: 1.6;
        }

        .intrusion-details strong {
            display: inline-block;
            min-width: 80px;
        }

        .intrusion-thumbnail {
            width: 100%;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        .intrusion-card.expanded .intrusion-thumbnail {
            display: block;
        }

        .no-intrusions {
            text-align: center;
            color: #999;
            padding: 40px;
            font-style: italic;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .stat-card.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
        }

        .stat-card.danger .stat-value {
            color: white;
        }

        .stat-card.danger .stat-label {
            color: rgba(255, 255, 255, 0.9);
        }

        /* æ²è»¸ç¾åŒ– */
        .intrusions-section::-webkit-scrollbar {
            width: 8px;
        }

        .intrusions-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .intrusions-section::-webkit-scrollbar-thumb {
            background: #ff4757;
            border-radius: 10px;
        }

        .intrusions-section::-webkit-scrollbar-thumb:hover {
            background: #c92a2a;
        }

        /* è­¦å ±é€šçŸ¥æ¨£å¼ */
        .alert-notification {
            background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideInRight 0.3s ease-out;
            position: relative;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-notification.fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }

        .alert-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .alert-content {
            font-size: 14px;
            opacity: 0.95;
        }

        /* åœ–ç‰‡é è¦½æ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            position: relative;
            top: 50%;
            transform: translateY(-50%);
        }

        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ff4757;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš¨ é›»å­åœç±¬ç›£æ§ç³»çµ± - å³æ™‚å±•ç¤º</h1>
            <span class="status" id="connection-status">â— é€£æ¥ä¸­...</span>
        </header>

        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-value" id="total-detections">0</div>
                <div class="stat-label">ç¸½åµæ¸¬æ•¸</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-value" id="fence-intrusions">0</div>
                <div class="stat-label">ğŸš¨ åœç±¬å…¥ä¾µäº‹ä»¶</div>
            </div>
        </div>

        <!-- è­¦å ±é€šçŸ¥å€ -->
        <div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;"></div>

        <div class="main-content">
            <div class="video-section">
                <h2>ğŸ“¹ å³æ™‚å½±åƒä¸²æµ</h2>
                <img id="video-stream" src="{{ url_for('video_feed') }}" alt="å½±åƒä¸²æµ">
            </div>

            <div class="intrusions-section">
                <h2>ğŸš¨ åœç±¬å…¥ä¾µäº‹ä»¶è¨˜éŒ„</h2>
                <div id="intrusions-container">
                    <div class="no-intrusions">ç­‰å¾…å…¥ä¾µäº‹ä»¶...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åœ–ç‰‡é è¦½æ¨¡æ…‹æ¡† -->
    <div id="imageModal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        // é€£æ¥ WebSocket
        console.log('ğŸš€ åˆå§‹åŒ– Socket.IO...');
        const socket = io('/detections', {
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5
        });

        let totalDetections = 0;
        let fenceIntrusions = 0;

        // ç‰©ä»¶é¡å‹å°æ‡‰çš„ Emoji
        const objectEmojis = {
            'car': 'ğŸš—',
            'truck': 'ğŸšš',
            'bus': 'ğŸšŒ',
            'motorcycle': 'ğŸï¸',
            'person': 'ğŸš¶',
            'bicycle': 'ğŸš´',
            'traffic light': 'ğŸš¦',
            'default': 'ğŸ“¦'
        };

        // ä¸­æ–‡ç¿»è­¯
        const objectNames = {
            'car': 'æ±½è»Š',
            'truck': 'å¡è»Š',
            'bus': 'å…¬è»Š',
            'motorcycle': 'æ©Ÿè»Š',
            'person': 'è¡Œäºº',
            'bicycle': 'è…³è¸è»Š',
            'traffic light': 'äº¤é€šè™ŸèªŒ'
        };

        socket.on('connect', function() {
            console.log('âœ… WebSocket å·²é€£æ¥ï¼');
            document.getElementById('connection-status').textContent = 'â— å·²é€£æ¥';
            document.getElementById('connection-status').style.background = '#10b981';

            // è¼‰å…¥æ­·å²å…¥ä¾µè¨˜éŒ„
            loadHistoricalIntrusions();
        });

        socket.on('disconnect', function(reason) {
            console.log('âŒ WebSocket å·²æ–·é–‹ï¼ŒåŸå› :', reason);
            document.getElementById('connection-status').textContent = 'â— å·²æ–·é–‹';
            document.getElementById('connection-status').style.background = '#ef4444';
        });

        socket.on('new_detection', function(data) {
            console.log('ğŸ¯ æ”¶åˆ°æ–°åµæ¸¬è³‡æ–™:', data);
            totalDetections++;
            document.getElementById('total-detections').textContent = totalDetections;
        });

        socket.on('fence_intrusion', function(data) {
            console.log('ğŸš¨ é›»å­åœç±¬è­¦å ±:', data);

            // æ›´æ–°è­¦å ±è¨ˆæ•¸
            fenceIntrusions++;
            document.getElementById('fence-intrusions').textContent = fenceIntrusions;

            // é¡¯ç¤ºè­¦å ±é€šçŸ¥
            showAlert(data);

            // æ·»åŠ åˆ°å…¥ä¾µè¨˜éŒ„åˆ—è¡¨
            addIntrusionCard(data);
        });

        function showAlert(data) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = 'alert-notification';

            const objectName = objectNames[data.object_class] || data.object_class;
            const objectEmoji = objectEmojis[data.object_class] || objectEmojis['default'];
            const time = new Date(data.timestamp).toLocaleTimeString('zh-TW');

            alert.innerHTML = `
                <div class="alert-title">ğŸš¨ é›»å­åœç±¬è­¦å ±</div>
                <div class="alert-content">
                    ${objectEmoji} <strong>${objectName}</strong> é€²å…¥ <strong>${data.fence_name}</strong><br>
                    ä¿¡å¿ƒåº¦: ${(data.confidence * 100).toFixed(1)}% | ${time}
                </div>
            `;

            container.appendChild(alert);

            // æ’­æ”¾è­¦å ±éŸ³æ•ˆï¼ˆå¯é¸ï¼‰
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZizcIHGi77eiYUA0PUKXi8bllHAU2kdry0H4sBSR3yPDckUELFF+06O2nVRQLRqDg8LxrIAMseM3z2Yw6CRlovO7qkFAODlGm4/K6Zh0FN5LZ89CALQQkecnx3ZFCDBF');
                audio.volume = 0.3;
                audio.play();
            } catch (e) {
                console.log('ç„¡æ³•æ’­æ”¾è­¦å ±éŸ³æ•ˆ');
            }

            // 5 ç§’å¾Œç§»é™¤é€šçŸ¥
            setTimeout(() => {
                alert.classList.add('fade-out');
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        }

        function addIntrusionCard(data) {
            const container = document.getElementById('intrusions-container');

            // ç§»é™¤ "ç­‰å¾…å…¥ä¾µäº‹ä»¶..." è¨Šæ¯
            const noIntrusions = container.querySelector('.no-intrusions');
            if (noIntrusions) {
                noIntrusions.remove();
            }

            // å»ºç«‹æ–°çš„å…¥ä¾µå¡ç‰‡
            const card = document.createElement('div');
            card.className = 'intrusion-card';

            const objectName = objectNames[data.object_class] || data.object_class;
            const objectEmoji = objectEmojis[data.object_class] || objectEmojis['default'];
            const timestamp = new Date(data.timestamp).toLocaleString('zh-TW');
            const confidence = (data.confidence * 100).toFixed(1);

            card.innerHTML = `
                <div class="intrusion-header">
                    <div class="intrusion-title">
                        ğŸš¨ ${data.fence_name}
                    </div>
                    <div class="intrusion-time">${timestamp}</div>
                </div>
                <div class="intrusion-details">
                    <div>${objectEmoji} <strong>ç‰©ä»¶:</strong> ${objectName}</div>
                    <div>ğŸ“Š <strong>ä¿¡å¿ƒåº¦:</strong> ${confidence}%</div>
                    <div>ğŸ“· <strong>æ”å½±æ©Ÿ:</strong> ${data.camera_name || 'æœªå‘½å'}</div>
                </div>
                ${data.snapshot_base64 ? `<img class="intrusion-thumbnail" src="data:image/jpeg;base64,${data.snapshot_base64}" alt="å…¥ä¾µæˆªåœ–">` : ''}
            `;

            // é»æ“Šå¡ç‰‡å±•é–‹/æ”¶åˆ
            card.addEventListener('click', function() {
                this.classList.toggle('expanded');
                if (this.classList.contains('expanded') && data.snapshot_base64) {
                    // é¡¯ç¤ºå¤§åœ–
                    showImageModal(data.snapshot_base64);
                }
            });

            // æ’å…¥åˆ°æœ€ä¸Šæ–¹
            container.insertBefore(card, container.firstChild);

            // é™åˆ¶æœ€å¤šé¡¯ç¤º 50 ç­†è¨˜éŒ„
            const cards = container.querySelectorAll('.intrusion-card');
            if (cards.length > 50) {
                cards[cards.length - 1].remove();
            }
        }

        function loadHistoricalIntrusions() {
            // è¼‰å…¥æ­·å²å…¥ä¾µè¨˜éŒ„
            fetch('/api/fence_intrusions?limit=20')
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data.length > 0) {
                        console.log(`è¼‰å…¥ ${result.data.length} ç­†æ­·å²å…¥ä¾µè¨˜éŒ„`);
                        fenceIntrusions = result.count;
                        document.getElementById('fence-intrusions').textContent = fenceIntrusions;

                        // åå‘é¡¯ç¤ºï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
                        result.data.reverse().forEach(intrusion => {
                            addIntrusionCard(intrusion);
                        });
                    }
                })
                .catch(error => {
                    console.error('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—:', error);
                });
        }

        function showImageModal(base64Image) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');

            modal.style.display = 'block';
            modalImg.src = 'data:image/jpeg;base64,' + base64Image;

            // é»æ“Šé—œé–‰æŒ‰éˆ•
            document.querySelector('.close').onclick = function() {
                modal.style.display = 'none';
            };

            // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }

        // å®šæœŸæ›´æ–°çµ±è¨ˆè³‡æ–™
        setInterval(function() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    // å¯ä»¥å¾å¾Œç«¯ç²å–æ›´ç²¾ç¢ºçš„çµ±è¨ˆ
                })
                .catch(error => console.error('ç²å–çµ±è¨ˆå¤±æ•—:', error));
        }, 5000);
    </script>
</body>
</html>
