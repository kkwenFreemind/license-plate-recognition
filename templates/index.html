<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLO Áâ©‰ª∂Ëæ®Ë≠òÁ≥ªÁµ± - Âç≥ÊôÇÂ±ïÁ§∫</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            background: #10b981;
            color: white;
            border-radius: 20px;
            font-size: 14px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .video-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .video-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }

        #video-stream {
            width: 100%;
            height: auto;
            border-radius: 8px;
            background: #000;
        }

        .results-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 800px;
            overflow-y: auto;
        }

        .results-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
            position: sticky;
            top: 0;
            background: white;
            padding-bottom: 10px;
        }

        .detection-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        #results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #results-table thead {
            position: sticky;
            top: 0;
            background: #667eea;
            color: white;
            z-index: 10;
        }

        #results-table th {
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #764ba2;
        }

        #results-table tbody tr {
            border-bottom: 1px solid #e5e5e5;
            transition: background-color 0.2s;
        }

        #results-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        #results-table tbody tr.new-row {
            animation: highlightRow 1s ease-out;
        }

        @keyframes highlightRow {
            from {
                background-color: #d4f1d4;
            }
            to {
                background-color: transparent;
            }
        }

        #results-table td {
            padding: 10px 12px;
        }

        .object-type {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .object-emoji {
            font-size: 20px;
        }

        .confidence {
            font-weight: bold;
            color: #667eea;
        }

        .confidence.high {
            color: #10b981;
        }

        .confidence.medium {
            color: #f59e0b;
        }

        .confidence.low {
            color: #ef4444;
        }

        .time {
            color: #666;
            font-size: 12px;
        }

        .no-results-row {
            text-align: center;
            color: #999;
            font-style: italic;
        }

        .no-results-row td {
            padding: 40px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .timestamp {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 10px;
        }

        /* Êç≤Ëª∏ÁæéÂåñ */
        .results-section::-webkit-scrollbar {
            width: 8px;
        }

        .results-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .results-section::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .results-section::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        /* Ë≠¶Â†±ÈÄöÁü•Ê®£Âºè */
        .alert-notification {
            background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideInRight 0.3s ease-out;
            position: relative;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .alert-notification.fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }
        
        .alert-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .alert-content {
            font-size: 14px;
            opacity: 0.95;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ YOLO Áâ©‰ª∂Ëæ®Ë≠òÁ≥ªÁµ± - Âç≥ÊôÇÂ±ïÁ§∫</h1>
            <span class="status" id="connection-status">‚óè ÈÄ£Êé•‰∏≠...</span>
        </header>

        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-value" id="total-detections">0</div>
                <div class="stat-label">Á∏ΩÂÅµÊ∏¨Êï∏</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-vehicles">0</div>
                <div class="stat-label">ËªäËºõÊï∏Èáè</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-persons">0</div>
                <div class="stat-label">‰∫∫Âì°Êï∏Èáè</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);">
                <div class="stat-value" id="fence-intrusions" style="color: white;">0</div>
                <div class="stat-label" style="color: rgba(255,255,255,0.9);">üö® ÂúçÁ±¨Ë≠¶Â†±</div>
            </div>
        </div>
        
        <!-- Ë≠¶Â†±ÈÄöÁü•ÂçÄ -->
        <div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;"></div>

        <div class="main-content">
            <div class="video-section">
                <h2>üìπ Âç≥ÊôÇÂΩ±ÂÉè‰∏≤ÊµÅ</h2>
                <img id="video-stream" src="{{ url_for('video_feed') }}" alt="ÂΩ±ÂÉè‰∏≤ÊµÅ">
            </div>

            <div class="results-section">
                <h2>üéØ Áâ©‰ª∂Ëæ®Ë≠òÁµêÊûú</h2>
                <div id="results-container">
                    <table id="results-table">
                        <thead>
                            <tr>
                                <th>Áâ©‰ª∂È°ûÂûã</th>
                                <th>‰ø°ÂøÉÂ∫¶</th>
                                <th>ÊôÇÈñì</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody">
                            <tr class="no-results-row">
                                <td colspan="3">Á≠âÂæÖËæ®Ë≠òÁµêÊûú...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÈÄ£Êé• WebSocket - ‰ΩøÁî®Êõ¥ÊòéÁ¢∫ÁöÑÈÖçÁΩÆ
        console.log('üöÄ ÂàùÂßãÂåñ Socket.IO...');
        const socket = io('/detections', {
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5
        });
        
        let totalDetections = 0;
        let totalVehicles = 0;
        let totalPersons = 0;
        let fenceIntrusions = 0;
        
        // Áâ©‰ª∂È°ûÂûãÂ∞çÊáâÁöÑ Emoji
        const objectEmojis = {
            'car': 'üöó',
            'truck': 'üöö',
            'bus': 'üöå',
            'motorcycle': 'üèçÔ∏è',
            'person': 'üö∂',
            'bicycle': 'üö¥',
            'traffic light': 'üö¶',
            'default': 'üì¶'
        };
        
        // ‰∏≠ÊñáÁøªË≠Ø
        const objectNames = {
            'car': 'Ê±ΩËªä',
            'truck': 'Âç°Ëªä',
            'bus': 'ÂÖ¨Ëªä',
            'motorcycle': 'Ê©üËªä',
            'person': 'Ë°å‰∫∫',
            'bicycle': 'ËÖ≥Ë∏èËªä',
            'traffic light': '‰∫§ÈÄöËôüË™å'
        };

        socket.on('connect', function() {
            console.log('‚úÖ WebSocket Â∑≤ÈÄ£Êé•ÔºÅ');
            console.log('üÜî Socket ID:', socket.id);
            console.log('üîó ÂëΩÂêçÁ©∫Èñì:', socket.nsp);
            document.getElementById('connection-status').textContent = '‚óè Â∑≤ÈÄ£Êé•';
            document.getElementById('connection-status').style.background = '#10b981';
        });

        socket.on('disconnect', function(reason) {
            console.log('‚ùå WebSocket Â∑≤Êñ∑ÈñãÔºåÂéüÂõ†:', reason);
            document.getElementById('connection-status').textContent = '‚óè Â∑≤Êñ∑Èñã';
            document.getElementById('connection-status').style.background = '#ef4444';
        });

        socket.on('status', function(data) {
            console.log('üì° Êî∂Âà∞ÁãÄÊÖãË®äÊÅØ:', data);
        });
        
        socket.on('connect_error', function(error) {
            console.error('‚ùå WebSocket ÈÄ£Êé•ÈåØË™§:', error);
            console.error('ÈåØË™§Ë©≥ÊÉÖ:', error.message);
        });
        
        // Áõ£ËÅΩÊâÄÊúâ‰∫ã‰ª∂ÔºàË™øË©¶Áî®Ôºâ
        socket.onAny((eventName, ...args) => {
            console.log(`üì® Êî∂Âà∞‰∫ã‰ª∂: ${eventName}`, args);
        });

        socket.on('new_detection', function(data) {
            console.log('üéØ Êî∂Âà∞Êñ∞ÂÅµÊ∏¨Ë≥áÊñô:', data);
            
            // Êõ¥Êñ∞Áµ±Ë®à
            totalDetections++;
            document.getElementById('total-detections').textContent = totalDetections;
            
            // Êõ¥Êñ∞ËªäËºõÂíå‰∫∫Âì°Áµ±Ë®à
            if (data.is_vehicle) {
                totalVehicles++;
                document.getElementById('total-vehicles').textContent = totalVehicles;
            } else if (data.object_class === 'person') {
                totalPersons++;
                document.getElementById('total-persons').textContent = totalPersons;
            }
            
            // È°ØÁ§∫ÊâÄÊúâÂÅµÊ∏¨ÁµêÊûú
            addDetectionCard(data);
        });
        
        socket.on('fence_intrusion', function(data) {
            console.log('üö® ÈõªÂ≠êÂúçÁ±¨Ë≠¶Â†±:', data);
            
            // Êõ¥Êñ∞Ë≠¶Â†±Ë®àÊï∏
            fenceIntrusions++;
            document.getElementById('fence-intrusions').textContent = fenceIntrusions;
            
            // È°ØÁ§∫Ë≠¶Â†±ÈÄöÁü•
            showAlert(data);
        });
        
        function showAlert(data) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = 'alert-notification';
            
            const objectName = objectNames[data.object_class] || data.object_class;
            const objectEmoji = objectEmojis[data.object_class] || objectEmojis['default'];
            const time = new Date(data.timestamp).toLocaleTimeString('zh-TW');
            
            alert.innerHTML = `
                <div class="alert-title">üö® ÈõªÂ≠êÂúçÁ±¨Ë≠¶Â†±</div>
                <div class="alert-content">
                    ${objectEmoji} <strong>${objectName}</strong> ÈÄ≤ÂÖ• <strong>${data.fence_name}</strong><br>
                    ‰ø°ÂøÉÂ∫¶: ${(data.confidence * 100).toFixed(1)}% | ${time}
                </div>
            `;
            
            container.appendChild(alert);
            
            // Êí≠ÊîæË≠¶Â†±Èü≥ÊïàÔºàÂèØÈÅ∏Ôºâ
            // new Audio('/static/alert.mp3').play();
            
            // 5 ÁßíÂæåÁßªÈô§ÈÄöÁü•
            setTimeout(() => {
                alert.classList.add('fade-out');
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        }

        function addDetectionCard(data) {
            const tbody = document.getElementById('results-tbody');
            
            // ÁßªÈô§ "Á≠âÂæÖËæ®Ë≠òÁµêÊûú..." Ë°å
            const noResultsRow = tbody.querySelector('.no-results-row');
            if (noResultsRow) {
                noResultsRow.remove();
            }
            
            // Âª∫Á´ãÊñ∞ÁöÑË°®Ê†ºË°å
            const row = document.createElement('tr');
            row.className = 'new-row';
            
            const objectClass = data.object_class;
            const objectEmoji = objectEmojis[objectClass] || objectEmojis['default'];
            const objectName = objectNames[objectClass] || objectClass;
            const timestamp = new Date(data.timestamp).toLocaleTimeString('zh-TW');
            const confidence = (data.confidence * 100).toFixed(1);
            
            // Ê†πÊìö‰ø°ÂøÉÂ∫¶Ë®≠ÂÆöÈ°èËâ≤
            let confidenceClass = 'confidence';
            if (confidence >= 80) {
                confidenceClass += ' high';
            } else if (confidence >= 60) {
                confidenceClass += ' medium';
            } else {
                confidenceClass += ' low';
            }
            
            // Âª∫Á´ãË°®Ê†ºÂÖßÂÆπ
            row.innerHTML = `
                <td>
                    <div class="object-type">
                        <span class="object-emoji">${objectEmoji}</span>
                        <span>${objectName}</span>
                    </div>
                </td>
                <td>
                    <span class="${confidenceClass}">${confidence}%</span>
                </td>
                <td>
                    <span class="time">${timestamp}</span>
                </td>
            `;
            
            // ÊèíÂÖ•Âà∞ÊúÄ‰∏äÊñπÔºàÁ¨¨‰∏ÄË°åÔºâ
            tbody.insertBefore(row, tbody.firstChild);
            
            // ÈôêÂà∂ÊúÄÂ§öÈ°ØÁ§∫ 50 Ë°å
            const rows = tbody.querySelectorAll('tr:not(.no-results-row)');
            if (rows.length > 50) {
                rows[rows.length - 1].remove();
            }
            
            // ÁßªÈô§È´ò‰∫ÆÂãïÁï´È°ûÂà•
            setTimeout(() => {
                row.classList.remove('new-row');
            }, 1000);
        }

        // ÂÆöÊúüÊõ¥Êñ∞Áµ±Ë®àË≥áÊñôÔºàÂèØÈÅ∏Ôºâ
        setInterval(function() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    // ÂèØ‰ª•ÂæûÂæåÁ´ØÁç≤ÂèñÊõ¥Á≤æÁ¢∫ÁöÑÁµ±Ë®à
                })
                .catch(error => console.error('Áç≤ÂèñÁµ±Ë®àÂ§±Êïó:', error));
        }, 5000);
    </script>
</body>
</html>
