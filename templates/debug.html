<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket è¨ºæ–·</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
        }
        .log {
            background: #000;
            border: 1px solid #00ff00;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
            overflow-y: auto;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .info { color: #00bfff; }
        .warning { color: #ffaa00; }
        h1 { color: #00ff00; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ” WebSocket é€£æ¥è¨ºæ–·</h1>
    
    <div>
        <button onclick="testConnection()">ğŸ”„ é‡æ–°é€£æ¥</button>
        <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
        <button onclick="sendTestEvent()">ğŸ“¤ ç™¼é€æ¸¬è©¦äº‹ä»¶</button>
    </div>
    
    <h2>é€£æ¥æ—¥èªŒï¼š</h2>
    <div id="log" class="log"></div>
    
    <h2>çµ±è¨ˆè³‡è¨Šï¼š</h2>
    <div id="stats" class="log" style="height: 100px;">
        <p>æ¥æ”¶è¨Šæ¯æ•¸: <span id="msgCount">0</span></p>
        <p>é€£æ¥ç‹€æ…‹: <span id="connStatus">æœªçŸ¥</span></p>
        <p>æœ€å¾Œè¨Šæ¯æ™‚é–“: <span id="lastMsg">ç„¡</span></p>
    </div>

    <script>
        let socket = null;
        let messageCount = 0;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString('zh-TW');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${time}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStats() {
            document.getElementById('msgCount').textContent = messageCount;
            document.getElementById('connStatus').textContent = socket && socket.connected ? 'âœ… å·²é€£æ¥' : 'âŒ æœªé€£æ¥';
            document.getElementById('lastMsg').textContent = new Date().toLocaleTimeString('zh-TW');
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            messageCount = 0;
            updateStats();
        }
        
        function testConnection() {
            log('ğŸ”„ å˜—è©¦é‡æ–°é€£æ¥...', 'warning');
            if (socket) {
                socket.disconnect();
            }
            initSocket();
        }
        
        function sendTestEvent() {
            if (socket && socket.connected) {
                socket.emit('test_event', { message: 'Hello from client!' });
                log('ğŸ“¤ å·²ç™¼é€æ¸¬è©¦äº‹ä»¶', 'info');
            } else {
                log('âŒ æœªé€£æ¥ï¼Œç„¡æ³•ç™¼é€', 'error');
            }
        }
        
        function initSocket() {
            log('ğŸš€ åˆå§‹åŒ– WebSocket é€£æ¥...', 'info');
            log(`ğŸ“ ç›®æ¨™: ${window.location.protocol}//${window.location.host}/detections`, 'info');
            
            socket = io('/detections', {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5
            });
            
            socket.on('connect', function() {
                log('âœ… WebSocket å·²é€£æ¥ï¼', 'success');
                log(`ğŸ†” Socket ID: ${socket.id}`, 'info');
                updateStats();
            });
            
            socket.on('disconnect', function(reason) {
                log(`âŒ WebSocket å·²æ–·é–‹: ${reason}`, 'error');
                updateStats();
            });
            
            socket.on('connect_error', function(error) {
                log(`âŒ é€£æ¥éŒ¯èª¤: ${error.message}`, 'error');
                log(`ğŸ“‹ éŒ¯èª¤è©³æƒ…: ${JSON.stringify(error)}`, 'error');
            });
            
            socket.on('error', function(error) {
                log(`âŒ Socket éŒ¯èª¤: ${error}`, 'error');
            });
            
            socket.on('status', function(data) {
                log(`ğŸ“¡ ç‹€æ…‹è¨Šæ¯: ${JSON.stringify(data)}`, 'info');
            });
            
            socket.on('new_detection', function(data) {
                messageCount++;
                log(`ğŸ¯ æ”¶åˆ°åµæ¸¬: ${data.object_class} (${(data.confidence * 100).toFixed(1)}%)`, 'success');
                log(`ğŸ“¦ å®Œæ•´è³‡æ–™: ${JSON.stringify(data)}`, 'info');
                updateStats();
            });
            
            // ç›£è½æ‰€æœ‰äº‹ä»¶
            socket.onAny((eventName, ...args) => {
                log(`ğŸ“¨ æ”¶åˆ°äº‹ä»¶: ${eventName}`, 'warning');
                log(`ğŸ“¦ äº‹ä»¶è³‡æ–™: ${JSON.stringify(args)}`, 'info');
            });
            
            // ç›£è½é€£æ¥éç¨‹
            socket.io.on('reconnect_attempt', () => {
                log('ğŸ”„ å˜—è©¦é‡æ–°é€£æ¥...', 'warning');
            });
            
            socket.io.on('reconnect', () => {
                log('âœ… é‡æ–°é€£æ¥æˆåŠŸï¼', 'success');
            });
            
            socket.io.on('reconnect_error', (error) => {
                log(`âŒ é‡æ–°é€£æ¥å¤±æ•—: ${error.message}`, 'error');
            });
        }
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸŒŸ é é¢è¼‰å…¥å®Œæˆ', 'info');
            log('ğŸ“š Socket.IO ç‰ˆæœ¬: ' + (io.version || 'æœªçŸ¥'), 'info');
            initSocket();
        };
    </script>
</body>
</html>
